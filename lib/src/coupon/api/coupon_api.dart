import 'package:dio/dio.dart';
import 'package:woocommerce_flutter_api/woocommerce_flutter_api.dart';

import '../models/coupon.dart';
import '../../base/enums/context.dart';
import '../../base/enums/order.dart';
import '../../base/enums/order_by.dart';

part 'endpoints.dart';

extension WooCouponApi on FlutterWooCommerce {
  /// [context] Scope under which the request is made; determines fields present in response. Options: view and edit. Default is view.
  ///
  /// [page] Current page of the collection. Default is 1.
  ///
  /// [perPage] Maximum number of items to be returned in result set. Default is 10.
  ///
  /// [search] Limit results to those matching a string.
  ///
  /// [after] Limit response to resources published after a given ISO8601 compliant date.
  ///
  /// [before] Limit response to resources published before a given ISO8601 compliant date.
  ///
  /// [modifiedAfter] Limit response to resources modified after a given ISO8601 compliant date.
  ///
  /// [modifiedBefore] Limit response to resources modified after a given ISO8601 compliant date.
  ///
  /// [datesAreGmt] Whether to consider GMT post dates when limiting response by published or modified date.
  ///
  /// [exclude] Ensure result set excludes specific IDs.
  ///
  /// [include] Limit result set to specific ids.
  ///
  /// [offset] Offset the result set by a specific number of items.
  ///
  /// [order] Order sort attribute ascending or descending. Options: asc and desc. Default is desc.
  ///
  /// [orderBy] Sort collection by object attribute. Options: date, id, include, title, slug, price, popularity and rating. Default is date.
  ///
  /// [code] Limit result set to resources with a specific code.
  ///
  /// [useFaker], fakes the api request
  Future<List<WooCoupon>> getCoupons({
    WooContext context = WooContext.view,
    int page = 1,
    int perPage = 10,
    String? search,
    DateTime? after,
    DateTime? before,
    DateTime? modifiedAfter,
    DateTime? modifiedBefore,
    bool? datesAreGmt,
    List<int>? exclude,
    List<int>? include,
    int? offset,
    WooSortOrder order = WooSortOrder.desc,
    WooSortOrderBy orderBy = WooSortOrderBy.date,
    String? code,
    bool? useFaker,
  }) async {
    final isUsingFaker = useFaker ?? this.useFaker;

    if (isUsingFaker) {
      return List.generate(perPage, (index) => WooCoupon.fake());
    }

    try {
      final response = await dio.get(
        _CouponEndpoints.coupons,
        queryParameters: _resolveQueryParametersForGettingCoupons(
          context: context,
          page: page,
          perPage: perPage,
          search: search,
          after: after,
          before: before,
          modifiedAfter: modifiedAfter,
          modifiedBefore: modifiedBefore,
          datesAreGmt: datesAreGmt,
          exclude: exclude,
          include: include,
          offset: offset,
          order: order,
          orderBy: orderBy,
          code: code,
        ),
      );
      if (response.statusCode != null &&
          response.statusCode! >= 200 &&
          response.statusCode! < 300) {
        final res = response.data as List<dynamic>;
        return res.map((item) => WooCoupon.fromJson(item)).toList();
      } else {
        throw Exception("API call failed with status code: " +
            response.statusCode.toString());
      }
    } on DioException catch (e) {
      final errorMsg = e.response?.data["message"] ?? e.message;
      throw Exception("API call failed: " + errorMsg);
    } catch (e, t) {
      dPrint(e.toString());
      dPrint(t.toString());
      throw Exception(
          "Unexpected error in API call: " + e.toString() + t.toString());
    }
  }

  Map<String, dynamic> _resolveQueryParametersForGettingCoupons({
    required WooContext context,
    required int page,
    required int perPage,
    required String? search,
    required DateTime? after,
    required DateTime? before,
    required DateTime? modifiedAfter,
    required DateTime? modifiedBefore,
    required bool? datesAreGmt,
    required List<int>? exclude,
    required List<int>? include,
    required int? offset,
    required WooSortOrder order,
    required WooSortOrderBy orderBy,
    required String? code,
  }) {
    final map = <String, dynamic>{
      'context': context.name,
      'page': page,
      'per_page': perPage,
      'order': order.name,
      'orderby': orderBy.name,
    };

    if (search != null) {
      map['search'] = search;
    }

    if (after != null) {
      map['after'] = after.toIso8601String();
    }

    if (before != null) {
      map['before'] = before.toIso8601String();
    }

    if (modifiedAfter != null) {
      map['modified_after'] = modifiedAfter.toIso8601String();
    }

    if (modifiedBefore != null) {
      map['modified_before'] = modifiedBefore.toIso8601String();
    }

    if (datesAreGmt != null) {
      map['dates_are_gmt'] = datesAreGmt;
    }

    if (exclude != null) {
      map['exclude'] = exclude.join(',');
    }

    if (include != null) {
      map['include'] = include.join(',');
    }

    if (offset != null) {
      map['offset'] = offset;
    }

    if (code != null) {
      map['code'] = code;
    }

    return map;
  }

  Future<WooCoupon> getCoupon({required int id, bool? useFaker}) async {
    final isUsingFaker = useFaker ?? this.useFaker;

    if (isUsingFaker) {
      return WooCoupon.fake();
    }

    try {
      final response = await dio.get(_CouponEndpoints.singleCoupon(id));
      if (response.statusCode != null &&
          response.statusCode! >= 200 &&
          response.statusCode! < 300) {
        return WooCoupon.fromJson(response.data as Map<String, dynamic>);
      } else {
        throw Exception("API call failed with status code: " +
            response.statusCode.toString());
      }
    } on DioException catch (e) {
      final errorMsg = e.response?.data["message"] ?? e.message;
      throw Exception("API call failed: " + errorMsg);
    } catch (e) {
      throw Exception("Unexpected error in API call: " + e.toString());
    }
  }
}

